<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŠ¤ë§ˆíŠ¸ ì¢Œì„ ë°°ì¹˜ v4.0 (ëª¨ë°”ì¼ ì—°ë™)</title>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary-gray: #4b5563; --mid-gray: #9ca3af; --light-gray: #e5e7eb; --bg-gray: #f3f4f6; --font-main: 'Gowun Dodum', sans-serif; --highlight-color: #ff4b4b; }
        body { font-family: var(--font-main); background-color: var(--bg-gray); margin: 0; padding: 20px; user-select: none; }
        #teacher-ui { display: none; gap: 20px; max-width: 1600px; margin: 0 auto; height: 95vh; }
        #student-ui { display: none; text-align: center; padding-top: 50px; }
        .left-panel { width: 420px; flex-shrink: 0; display: flex; flex-direction: column; gap: 5px; overflow-y: auto; }
        .menu-card { background: #fff; border: 1px solid #d1d5db; margin-bottom: 5px; }
        .accordion-header { padding: 14px; background: #f9fafb; cursor: pointer; font-weight: bold; color: var(--primary-gray); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .active .accordion-content { max-height: 600px; border-top: 1px solid #eee; }
        .accordion-inner { padding: 15px; }
        .btn-rect { width: 100%; padding: 12px; border: 1px solid #374151; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .btn-dark { background: #374151; color: white; }
        .btn-mid { background: #6b7280; color: white; }
        .btn-light { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .right-panel { flex-grow: 1; display: flex; flex-direction: column; align-items: center; background: #d1d5db; padding: 40px; overflow: auto; border-radius: 8px; }
        #seatingGrid { display: grid; gap: 15px; }
        .seat { width: 110px; height: 110px; position: relative; }
        .seat-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .seat-inner { transform: rotateY(180deg); }
        .seat-front, .seat-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border: 2px solid #374151; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; }
        .seat-front { transform: rotateY(180deg); }
        .seat-back { background: #9ca3af; color: white; font-size: 2.5rem; font-weight: bold; }
        .seat-back::after { content: "?"; }
        .seat.is-none .seat-back::after { content: "X"; color: #ff6b6b; }
        .highlight-reveal { z-index: 100; outline: 6px solid var(--highlight-color); box-shadow: 0 0 25px rgba(255, 75, 75, 0.8); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { outline-offset: 0; } 50% { outline-offset: 5px; } 100% { outline-offset: 0; } }
        .student-input { width: 80%; padding: 15px; font-size: 1.5rem; border: 2px solid var(--primary-gray); margin-bottom: 20px; text-align: center; }
        .student-btn { width: 80%; padding: 20px; font-size: 1.5rem; background: var(--primary-gray); color: white; border: none; font-weight: bold; }
        #qr-container { background: white; padding: 10px; display: inline-block; margin-top: 10px; }
    </style>
</head>
<body>

<div id="teacher-ui">
    <div class="left-panel">
        <button onclick="openMobileLink()" class="btn-rect btn-dark">ğŸ“± ëª¨ë°”ì¼ ì ‘ì† ì—´ê¸° (QR)</button>
        <div id="qr-area" style="display:none; text-align:center; background:white; padding:10px; border:1px solid #ddd;">
            <div id="qr-container"></div>
            <p style="font-size:0.8rem;">í•™ìƒë“¤ì€ ì´ QRì„ ì°ì–´ì£¼ì„¸ìš”</p>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top:5px;">
            <button class="btn-rect btn-mid" onclick="startPlacement('id_order')">ë²ˆí˜¸ìˆœ</button>
            <button class="btn-rect btn-mid" onclick="startPlacement('lottery')">ì œë¹„ë½‘ê¸° ì‹œì‘</button>
        </div>
        <div class="menu-card active">
            <div class="accordion-header">ğŸ‘¥ í•™ìƒ ëª…ë‹¨</div>
            <div class="accordion-content" style="max-height: 400px;">
                <div class="accordion-inner">
                    <input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none;" onchange="readExcel(this)">
                    <button class="btn-rect btn-light" onclick="document.getElementById('excelInput').click()" style="background-color: #e1effe;">ğŸ“‚ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <div id="studentList"></div>
                    <button class="btn-rect btn-light" onclick="addStudentRow()">+ í•™ìƒ ì¶”ê°€</button>
                    <button class="btn-rect btn-light" onclick="saveMasterList()">ğŸ’¾ ëª…ë‹¨ ì €ì¥</button>
                </div>
            </div>
        </div>
        <button onclick="window.print()" class="btn-rect btn-light">ğŸ–¨ï¸ ê²°ê³¼ ì¸ì‡„</button>
    </div>
    <div class="right-panel">
        <div style="width:500px; padding:15px; background:#4b5563; color:white; text-align:center; margin-bottom:40px; font-weight:bold;">ì¹  íŒ</div>
        <div id="seatingGrid"></div>
    </div>
</div>

<div id="student-ui">
    <h1 id="status-msg">ìê¸° ìë¦¬ë¥¼ í™•ì¸í•˜ì„¸ìš”</h1>
    <input type="number" id="myNumber" class="student-input" placeholder="ë³¸ì¸ ë²ˆí˜¸ ì…ë ¥">
    <br>
    <button onclick="revealMySeat()" id="revealBtn" class="student-btn">ìë¦¬ í™•ì¸í•˜ê¸°!</button>
    <p id="result-msg" style="margin-top:20px; font-weight:bold;"></p>
</div>
<input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none;" onchange="readExcel(this)">
  



<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAsCQ-4Kx5Cpiu2IHpRiBWzCQ5SX3qzkdI",
        authDomain: "smartseating-4a78c.firebaseapp.com",
        databaseURL: "https://smartseating-4a78c-default-rtdb.firebaseio.com/", 
        projectId: "smartseating-4a78c",
        storageBucket: "smartseating-4a78c.firebasestorage.app",
        messagingSenderId: "514146659460",
        appId: "1:514146659460:web:91038077f453ce87a5e6d1",
        measurementId: "G-NTYPDER042"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');

    if (mode === 'student') {
        document.getElementById('student-ui').style.display = 'block';
    } else {
        document.getElementById('teacher-ui').style.display = 'flex';
        initTeacher();
    }

    function initTeacher() {
        loadMasterList(); 
        generateGrid();
        db.ref('reveal_event').on('value', (snapshot) => {
            const val = snapshot.val();
            if (val && val.id) revealSeat(val.id);
        });
    }

    function generateGrid() {
        const grid = document.getElementById('seatingGrid');
        grid.style.gridTemplateColumns = `repeat(6, 110px)`;
        grid.innerHTML = '';
        for (let i = 0; i < 36; i++) {
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.innerHTML = `<div class="seat-inner"><div class="seat-back"></div><div class="seat-front"></div></div>`;
            seat.addEventListener('dblclick', () => seat.classList.toggle('is-none'));
            grid.appendChild(seat);
        }
    }

  function startPlacement(type) {
    // 1. ì…ë ¥ëœ í•™ìƒ ëª…ë‹¨ ê°€ì ¸ì˜¤ê¸°
    const students = Array.from(document.querySelectorAll('.student-row')).map(row => ({
        id: row.querySelector('.in-id').value,
        name: row.querySelector('.in-name').value.trim()
    })).filter(s => s.name !== "");

    // 2. ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìë¦¬(X í‘œì‹œ ì•ˆ ëœ ìë¦¬) ì°¾ê¸°
    const availableSeats = Array.from(document.querySelectorAll('.seat:not(.is-none)'));

    if (students.length > availableSeats.length) {
        alert(`í•™ìƒ ìˆ˜(${students.length}ëª…)ê°€ ë¹ˆ ìë¦¬(${availableSeats.length}ê°œ)ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤!`);
        return;
    }

    // 3. ì œë¹„ë½‘ê¸° ëª¨ë“œì¼ ê²½ìš° ìë¦¬ ìˆœì„œë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ê¸°
    if (type === 'lottery') {
        availableSeats.sort(() => Math.random() - 0.5);
    } else {
        // ë²ˆí˜¸ìˆœì¼ ê²½ìš° í•™ìƒ ëª…ë‹¨ì„ ë²ˆí˜¸ìˆœìœ¼ë¡œ ì •ë ¬ (ì„ íƒ ì‚¬í•­)
        students.sort((a, b) => Number(a.id) - Number(b.id));
    }

    // 4. ëª¨ë“  ìë¦¬ ì´ˆê¸°í™” (ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ë° ë’¤ì§‘ê¸° í•´ì œ)
    document.querySelectorAll('.seat').forEach(seat => {
        delete seat.dataset.id;
        seat.querySelector('.seat-front').innerHTML = '';
        seat.classList.remove('flipped', 'highlight-reveal');
    });

    // 5. ì„œë²„(Firebase)ì˜ ê¸°ì¡´ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
    db.ref('reveal_event').set(null);

    // 6. ì„ì¸ ìë¦¬ì— í•™ìƒ ë°°ì¹˜
    availableSeats.forEach((seat, i) => {
        if (students[i]) {
            seat.dataset.id = students[i].id; // í•™ìƒ ë²ˆí˜¸ë¥¼ ìë¦¬ ë°ì´í„°ì— ì €ì¥
            const front = seat.querySelector('.seat-front');
            front.innerHTML = `
                <div style="font-size:0.8rem;color:#666">${students[i].id}</div>
                <div style="font-size:1.1rem;font-weight:bold">${students[i].name}</div>
            `;
        }
    });

    alert(type === 'lottery' ? "ì œë¹„ë½‘ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì¹´ë“œê°€ ë’¤ì§‘í˜”ìŠµë‹ˆë‹¤." : "ë²ˆí˜¸ìˆœ ë°°ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
}

    function revealSeat(studentId) {
        const target = document.querySelector(`.seat[data-id="${studentId}"]`);
        if (target) {
            document.querySelectorAll('.seat').forEach(s => s.classList.remove('highlight-reveal'));
            target.classList.add('flipped', 'highlight-reveal');
        }
    }

    function openMobileLink() {
        const area = document.getElementById('qr-area');
        area.style.display = area.style.display === 'none' ? 'block' : 'none';
        if (area.style.display === 'block') {
            const studentUrl = window.location.href.split('?')[0] + '?mode=student';
            document.getElementById('qr-container').innerHTML = '';
            new QRCode(document.getElementById('qr-container'), { text: studentUrl, width: 150, height: 150 });
        }
    }

    function revealMySeat() {
        const id = document.getElementById('myNumber').value;
        if (!id) return alert("ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
        db.ref('reveal_event').set({ id: id, time: Date.now() });
        document.getElementById('revealBtn').disabled = true;
        document.getElementById('revealBtn').innerText = "ê³µê°œ ì™„ë£Œ!";
        document.getElementById('status-msg').innerText = "ì¹ íŒì„ í™•ì¸í•˜ì„¸ìš”!";
    }

    function addStudentRow(id = '', name = '') {
        const div = document.createElement('div'); div.className = 'student-row'; div.style.display = 'flex'; div.style.marginBottom = '2px';
        div.innerHTML = `<input type="text" class="in-id" value="${id}" style="width:30px"><input type="text" class="in-name" value="${name}" style="flex:1">`;
        document.getElementById('studentList').appendChild(div);
    }
    function saveMasterList() { localStorage.setItem('seat_master', JSON.stringify(Array.from(document.querySelectorAll('.student-row')).map(r => ({ id: r.querySelector('.in-id').value, name: r.querySelector('.in-name').value })))); alert('ì €ì¥ë¨'); }
    function loadMasterList() { const data = JSON.parse(localStorage.getItem('seat_master') || '[]'); data.forEach(s => addStudentRow(s.id, s.name)); if (data.length === 0) for (let i = 0; i < 5; i++) addStudentRow(); }

    function readExcel(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet);
            if (confirm(`${rows.length}ëª…ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?`)) {
                document.getElementById('studentList').innerHTML = '';
                rows.forEach(row => {
                    const grade = row['í•™ë…„'] || ''; const ban = row['ë°˜'] || ''; const num = row['ë²ˆí˜¸'] || ''; const name = row['ì„±ëª…'] || row['ì´ë¦„'] || '';
                    addStudentRow(num, grade ? `${grade}-${ban} ${name}` : name);
                });
            }
        };
        reader.readAsArrayBuffer(file);
        input.value = '';
    }
    function readExcel(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]]; // ì²« ë²ˆì§¸ ì‹œíŠ¸ ì„ íƒ
        const rows = XLSX.utils.sheet_to_json(sheet); // JSONìœ¼ë¡œ ë³€í™˜
        
        if (confirm(`${rows.length}ëª…ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?`)) {
            document.getElementById('studentList').innerHTML = ''; // ê¸°ì¡´ ëª…ë‹¨ ë¹„ìš°ê¸°
            rows.forEach(row => {
                // ì—‘ì…€ í—¤ë”: í•™ë…„, ë°˜, ë²ˆí˜¸, ì„±ëª…(ë˜ëŠ” ì´ë¦„)
                const grade = row['í•™ë…„'] || ''; 
                const ban = row['ë°˜'] || ''; 
                const num = row['ë²ˆí˜¸'] || ''; 
                const name = row['ì„±ëª…'] || row['ì´ë¦„'] || '';
                
                // í•™ìƒ ì¶”ê°€ í•¨ìˆ˜ í˜¸ì¶œ
                addStudentRow(num, grade ? `${grade}-${ban} ${name}` : name);
            });
        }
    };
    reader.readAsArrayBuffer(file);
    input.value = ''; // ì´ˆê¸°í™”
}
</script>
</body>
</html>